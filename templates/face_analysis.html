{% extends 'layout.html' %}

{% block content %}
<style>
  /* Global Blue Theme & Professional Styling */
  body {
      background-color: #f0f8ff; /* AliceBlue */
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  .container-main {
      min-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
  }
  h1, h2, h3, h4 {
      font-weight: 700;
  }
  /* Upload Box */
  .upload-box {
      background: rgba(255, 255, 255, 0.9);
      border: 2px dashed #007BFF;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      cursor: pointer;
  }
  .upload-box:hover {
      background: #e6f0ff;
      border-color: #0056b3;
  }
  .upload-box input[type="file"] {
      display: none;
  }
  .feedback {
      color: #007BFF;
      font-size: 1.1rem;
      margin-top: 10px;
  }
  /* Results Containers */
  .results-section {
      margin-top: 30px;
  }
  .predictions-container, .recommendations-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
  }
  .condition-title {
      color: #007BFF;
      font-weight: bold;
      margin-bottom: 10px;
  }
  .product-list {
      list-style: none;
      padding: 0;
      margin: 0;
  }
  .product-list li {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
  }
  .product-list li:last-child {
      border-bottom: none;
  }
  /* Annotated Image */
  .annotated-img {
      margin-top: 20px;
      max-height: 400px;
      width: 100%;
      border: 2px solid #007BFF;
      border-radius: 8px;
      object-fit: contain;
  }
  /* Blue Button */
  .blue-button {
      background-color: #007BFF;
      color: #fff;
      font-size: 1.2rem;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s ease;
  }
  .blue-button:hover {
      background-color: #0056b3;
  }
</style>

<div class="container-main">
  <div class="w-100" style="max-width: 600px;">
    <h1 class="text-center mb-3" style="color: #007BFF; font-size: 2.5rem;">AI Skin Analysis</h1>
    <p class="text-center mb-4" style="color: #555;">Upload your image for an expert AI evaluation of your skin.</p>
    
    <!-- Upload Form -->
    <form action="/predict" method="post" enctype="multipart/form-data">
      <div class="upload-box" id="uploadBox">
        <input id="file" type="file" name="image" accept="image/*" required>
        <h3>Drag & Drop your image here, or click to select</h3>
        <p id="fileFeedback" class="feedback" style="display: none;">File Selected!</p>
      </div>
      <div class="text-center mt-3">
        <button class="blue-button" type="submit">Predict</button>
      </div>
    </form>

    <!-- Results Section (Rendered after form submission) -->
    <div id="resultsSection" class="results-section" style="display: none;">
      <div class="predictions-container" id="predictionsContainer">
        <h2 class="condition-title">Predictions:</h2>
        <ul id="predictionList" class="product-list"></ul>
      </div>
      <div class="recommendations-container" id="recommendationsContainer">
        <h2 class="condition-title">Recommendations:</h2>
        <ul id="recommendationList" class="product-list"></ul>
      </div>
      <img id="annotatedImage" class="annotated-img" src="" alt="Annotated Image" style="display: none;">
    </div>
  </div>
</div>

<script>
  // Handle file input click & feedback
  const fileInput = document.getElementById('file');
  const uploadBox = document.getElementById('uploadBox');
  const fileFeedback = document.getElementById('fileFeedback');

  uploadBox.addEventListener('click', () => {
      fileInput.click();
  });

  fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
          fileFeedback.style.display = 'block';
          fileFeedback.textContent = "File Selected: " + fileInput.files[0].name;
      } else {
          fileFeedback.style.display = 'none';
      }
  });

  // Parse prediction data passed from Flask (if any)
  var data = '{{ data | tojson | safe }}';
  if (data) {
      try {
          const jsonData = JSON.parse(data);
          if (Object.keys(jsonData).length > 0) {
              renderResults(jsonData);
          }
      } catch(e) {
          console.error("Error parsing JSON data: ", e);
      }
  }

  function renderResults(jsonData) {
      // Render Predictions
      const predictionList = document.getElementById('predictionList');
      predictionList.innerHTML = '';
      if (jsonData.classes && jsonData.classes.length > 0) {
          jsonData.classes.forEach(condition => {
              const li = document.createElement('li');
              li.textContent = condition;
              predictionList.appendChild(li);
          });
      } else {
          predictionList.innerHTML = '<li>No predictions available.</li>';
      }
      document.getElementById('predictionsContainer').style.display = 'block';

      // Render Recommendations
      const recommendationList = document.getElementById('recommendationList');
      recommendationList.innerHTML = '';
      if (jsonData.recommendations && jsonData.recommendations.length > 0) {
          jsonData.recommendations.forEach(item => {
              const condition = item[0];
              const products = item[1];
              let li = document.createElement('li');
              li.innerHTML = `<strong>${condition}:</strong>`;
              if (products && products.length > 0) {
                  products.forEach(product => {
                      let prodLi = document.createElement('li');
                      // Clean up ingredients string if needed
                      let ingredients = product.Ingredients.replace(/[^a-zA-Z0-9\s,]/g, "");
                      prodLi.innerHTML = `<span><strong>Brand:</strong> ${product.Brand}</span><br>
                                            <span><strong>Name:</strong> ${product.Name}</span><br>
                                            <span><strong>Price:</strong> $${product.Price}</span><br>
                                            <span><strong>Ingredients:</strong> ${ingredients}</span>`;
                      li.appendChild(prodLi);
                  });
              } else {
                  li.innerHTML += " No products available.";
              }
              recommendationList.appendChild(li);
          });
      } else {
          recommendationList.innerHTML = '<li>No recommendations available.</li>';
      }
      document.getElementById('recommendationsContainer').style.display = 'block';

      // Display Annotated Image if available
      const annotatedImg = document.getElementById('annotatedImage');
      if (jsonData.classes && jsonData.classes.length > 0) {
          annotatedImg.src = "/static/annotations_0.jpg";
          annotatedImg.style.display = 'block';
      }
      document.getElementById('resultsSection').style.display = 'block';
  }
</script>
{% endblock %}
