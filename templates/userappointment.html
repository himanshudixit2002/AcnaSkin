{% extends 'layout.html' %}

{% block content %}
<div class="h-[100vh] w-full relative flex flex-col items-center justify-center bg-gray-100">
    <div class="h-[70vh] w-full flex flex-col justify-center items-center gap-9 z-20">
        
        <!-- Header -->
        <div class="h-[10vh] w-full flex items-center justify-center">
            <h1 class="text-black text-5xl md:text-6xl font-serif flex items-center gap-4">
                <i class="fa-solid fa-calendar-check text-6xl md:text-7xl text-blue-600"></i> 
                <span>Doctor's Appointments</span>
            </h1>
        </div>

        <!-- Appointment List -->
        <div id="appointmentsContainer" class="h-[80vh] w-4/5 bg-white bg-opacity-95 p-8 rounded-xl shadow-lg shadow-gray-500 overflow-y-auto flex flex-col gap-3">
            <p id="noAppointmentsMsg" class="text-center text-gray-500 text-xl hidden">No appointments found.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let appointments = [];

    // Fetch appointments from the server
    function fetchAppointments() {
        fetch("/userappointment")
            .then(response => response.json())
            .then(data => {
                appointments = data.all_appointments || [];
                renderAppointments();
            })
            .catch(error => console.error("Error fetching appointments:", error));
    }

    const container = document.getElementById("appointmentsContainer");
    const noAppointmentsMsg = document.getElementById("noAppointmentsMsg");

    function renderAppointments() {
        container.innerHTML = ""; // Clear previous items

        if (appointments.length === 0) {
            noAppointmentsMsg.classList.remove("hidden");
            return;
        } else {
            noAppointmentsMsg.classList.add("hidden");
        }

        appointments.forEach((appointment) => {
            const appointmentDiv = document.createElement("div");
            appointmentDiv.classList.add(
                "h-auto", "w-full", "bg-gray-100", "p-5", "rounded-xl", "border",
                "border-gray-300", "shadow-md", "hover:bg-blue-50", "transition-all",
                "flex", "flex-col", "gap-2", "relative"
            );

            const status = parseInt(appointment.status) === 0 ? "Pending" : "Accepted";
            const statusColor = status === "Pending" ? "text-red-500" : "text-green-500";

            appointmentDiv.innerHTML = `
                <p class="text-lg"><strong>Name:</strong> ${appointment.name}</p>
                <p class="text-lg"><strong>Email:</strong> ${appointment.email}</p>
                <p class="text-lg"><strong>Date:</strong> ${appointment.date}</p>
                <p class="text-lg"><strong>Skin Type:</strong> ${appointment.skin}</p>
                <p class="text-lg"><strong>Status:</strong> <span class="${statusColor} font-bold">${status}</span></p>
            `;

            // Delete button
            const deleteIcon = document.createElement("i");
            deleteIcon.classList.add(
                "fas", "fa-trash-alt", "cursor-pointer", "text-red-500",
                "absolute", "top-4", "right-4", "hover:text-red-700", "transition-all", "text-xl"
            );
            deleteIcon.setAttribute("aria-hidden", "true");
            deleteIcon.addEventListener("click", () => handleDelete(appointment.id, appointmentDiv));

            appointmentDiv.appendChild(deleteIcon);
            container.appendChild(appointmentDiv);
        });
    }
    
    function handleDelete(appointmentId, appointmentDiv) {
        if (!confirm("Are you sure you want to delete this appointment?")) return;

        fetch("/delete_user_request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: appointmentId }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Appointment deleted successfully") {
                console.log("Deleted successfully:", data);

                // Remove from UI with fade-out animation
                appointmentDiv.classList.add("opacity-0", "transition-opacity", "duration-500");
                setTimeout(() => {
                    appointmentDiv.remove();
                    checkNoAppointments();
                }, 500);
            } else {
                console.error("Error deleting appointment:", data.error);
            }
        })
        .catch(error => console.error("Error deleting appointment:", error));
    }

    // Function to show "No Appointments" message when empty
    function checkNoAppointments() {
        if (document.querySelectorAll("#appointmentsContainer div").length === 0) {
            document.getElementById("noAppointmentsMsg").classList.remove("hidden");
        }
    }

    // Fetch appointments initially and auto-refresh every 5 seconds
    fetchAppointments();
    setInterval(fetchAppointments, 5000);
});
</script>
{% endblock %}
