{% extends 'layout.html' %}

{% block content %}
<div class="min-h-screen w-full flex flex-col items-center justify-center bg-gray-100 px-4">
    <div class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-blue-600 flex items-center justify-center gap-2">
            <i class="fa-solid fa-calendar-check text-blue-500"></i> My Appointments
        </h1>
        <div id="appointmentsContainer" class="mt-6 space-y-4">
            <p id="noAppointmentsMsg" class="text-center text-gray-500 text-xl hidden">No appointments found.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("appointmentsContainer");
    const noAppointmentsMsg = document.getElementById("noAppointmentsMsg");

    // Fetch appointments from the server via AJAX
    async function fetchAppointments() {
        try {
            const response = await fetch("/userappointment", { 
                headers: { "X-Requested-With": "XMLHttpRequest" } 
            });
            const data = await response.json();
            if (data.error) {
                console.error("Error:", data.error);
                return;
            }
            renderAppointments(data.all_appointments);
        } catch (error) {
            console.error("Error fetching appointments:", error);
        }
    }

    // Render appointments in the UI
    function renderAppointments(appointments) {
        container.innerHTML = ""; // Clear previous items

        if (!appointments || appointments.length === 0) {
            noAppointmentsMsg.classList.remove("hidden");
            return;
        } else {
            noAppointmentsMsg.classList.add("hidden");
        }

        appointments.forEach((appointment) => {
            const appointmentDiv = document.createElement("div");
            appointmentDiv.setAttribute("id", `appointment-${appointment.id}`);
            appointmentDiv.classList.add(
                "p-4", "bg-gray-100", "rounded-lg", "shadow-md", "flex", 
                "justify-between", "items-center", "transition-all", "duration-300"
            );

            // Ensure appointment.status is parsed correctly
            const statusVal = parseInt(appointment.status);
            const status = statusVal === 0 ? "Pending" : "Accepted";
            const statusColor = status === "Pending" ? "text-red-500" : "text-green-500";

            appointmentDiv.innerHTML = `
                <div>
                    <p class="text-lg"><strong>Name:</strong> ${appointment.name}</p>
                    <p class="text-lg"><strong>Date:</strong> ${appointment.date}</p>
                    <p class="text-lg"><strong>Status:</strong> <span class="${statusColor} font-bold">${status}</span></p>
                </div>
                <button onclick="deleteAppointment(${appointment.id})" 
                    class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-all">
                    Delete
                </button>
            `;

            container.appendChild(appointmentDiv);
        });
    }

    // Delete a specific appointment
    async function deleteAppointment(id) {
        if (!confirm("Are you sure you want to delete this appointment?")) return;
        try {
            const response = await fetch("/delete_user_request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: id })
            });
            const data = await response.json();
            console.log("Delete response:", data);
            if (data.message === "deleted successfully") {
                // Remove only the specific appointment element using its unique ID
                const appointmentDiv = document.getElementById(`appointment-${id}`);
                if (appointmentDiv) {
                    appointmentDiv.classList.add("opacity-0", "transition-opacity", "duration-500");
                    setTimeout(() => {
                        appointmentDiv.remove();
                        checkNoAppointments();
                    }, 500);
                }
            } else {
                console.error("Error deleting appointment:", data.error);
            }
        } catch (error) {
            console.error("Error deleting appointment:", error);
        }
    }

    // Function to show "No Appointments" message if container is empty
    function checkNoAppointments() {
        if (container.children.length === 0) {
            noAppointmentsMsg.classList.remove("hidden");
        }
    }

    // Fetch appointments initially and auto-refresh every 5 seconds
    fetchAppointments();
    setInterval(fetchAppointments, 5000);
});
</script>
{% endblock %}
